<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Medical Profile Setup - KantanCare</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.7/dist/iconify-icon.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }
      
      :root {
        --background: #f7fafd;
        --foreground: #0f1724;
        --border: #00000014;
        --input: #ffffff;
        --primary: #0466c8;
        --primary-foreground: #ffffff;
        --secondary: #e9f2ff;
        --secondary-foreground: #073b66;
        --muted: #f1f5f9;
        --muted-foreground: #98a0aa;
        --success: #0f9d58;
        --success-foreground: #ffffff;
        --accent: #ffb142;
        --accent-foreground: #1a2a31;
        --destructive: #e02424;
        --destructive-foreground: #ffffff;
        --warning: #f59e0b;
        --warning-foreground: #08131a;
        --card: #ffffff;
        --card-foreground: #0f1724;
        --sidebar: #f1f7fb;
        --sidebar-foreground: #0c1720;
        --sidebar-primary: #0466c8;
        --sidebar-primary-foreground: #ffffff;
        --radius-sm: 4px;
        --radius-md: 6px;
        --radius-lg: 8px;
        --radius-xl: 12px;
        --font-family-body: Inter, sans-serif;
      }

      body,
      html {
        margin: 0;
        padding: 0;
        font-family: var(--font-family-body);
        background-color: var(--background);
        color: var(--foreground);
        height: 100vh;
        overflow: hidden;
      }

      h1, h2, h3, h4, p {
        margin: 0;
      }

      .app-container {
        display: flex;
        width: 100%;
        height: 100%;
      }

      /* Sidebar */
      .sidebar {
        width: 260px;
        background-color: var(--sidebar);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        padding: 24px 16px;
        flex-shrink: 0;
      }

      .logo-area {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 0 12px;
        margin-bottom: 32px;
      }
      
      .logo-icon {
        width: 32px;
        height: 32px;
        background-color: var(--primary);
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-foreground);
        font-weight: 700;
        font-size: 16px;
      }
      
      .logo-text {
        font-weight: 600;
        font-size: 18px;
        color: var(--sidebar-foreground);
      }

      .nav-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-bottom: 32px;
      }

      .nav-label {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--muted-foreground);
        font-weight: 600;
        padding: 0 12px;
        margin-bottom: 8px;
        letter-spacing: 0.5px;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: var(--radius-md);
        color: var(--sidebar-foreground);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
        text-decoration: none;
      }
      
      .nav-item:hover {
        background-color: var(--secondary);
      }
      
      .nav-item.active {
        background-color: var(--sidebar-primary);
        color: var(--sidebar-primary-foreground);
      }

      .spacer {
        flex: 1;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: var(--background);
        overflow: hidden;
      }

      .top-bar {
        height: 64px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 32px;
        background-color: var(--background);
      }

      .breadcrumbs {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: var(--muted-foreground);
      }
      
      .breadcrumb-active {
        color: var(--foreground);
        font-weight: 500;
      }

      .user-actions {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      /* Scrollable Content Area */
      .scroll-area {
        flex: 1;
        overflow-y: auto;
        padding: 32px;
        display: flex;
        justify-content: center;
      }

      .content-width {
        max-width: 700px;
        width: 100%;
      }

      /* Header Section */
      .header-section {
        margin-bottom: 32px;
      }
      
      .page-title {
        font-size: 28px;
        font-weight: 600;
        color: var(--foreground);
        margin: 0 0 8px 0;
      }
      
      .page-subtitle {
        font-size: 15px;
        color: var(--muted-foreground);
        line-height: 1.6;
      }

      /* Progress Bar */
      .progress-wrapper {
        margin-bottom: 32px;
      }

      .progress-bar {
        background: var(--muted);
        height: 6px;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 12px;
      }

      .progress-fill {
        background: var(--primary);
        height: 100%;
        width: 50%;
        transition: width 0.3s;
        border-radius: 3px;
      }

      .step-indicator {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        color: var(--muted-foreground);
      }

      .step-indicator span.active {
        color: var(--primary);
        font-weight: 600;
      }

      /* Form Card */
      .form-card {
        background: var(--card);
        border-radius: var(--radius-xl);
        padding: 28px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
      }

      .step {
        display: none;
      }

      .step.active {
        display: block;
      }

      .step-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--foreground);
        margin-bottom: 8px;
      }

      .step-subtitle {
        font-size: 14px;
        color: var(--muted-foreground);
        margin-bottom: 24px;
      }

      .info-box {
        background: var(--secondary);
        border: 1px solid rgba(4, 102, 200, 0.2);
        border-radius: var(--radius-lg);
        padding: 16px;
        margin-bottom: 24px;
        font-size: 14px;
        color: var(--secondary-foreground);
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      label {
        display: block;
        color: var(--foreground);
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      input[type="number"],
      input[type="text"],
      select {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        font-size: 15px;
        transition: all 0.2s;
        background: var(--input);
        font-family: inherit;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(4, 102, 200, 0.1);
      }

      textarea {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        font-size: 15px;
        transition: all 0.2s;
        background: var(--input);
        resize: vertical;
        min-height: 100px;
        font-family: inherit;
      }

      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(4, 102, 200, 0.1);
      }

      .button-group {
        display: flex;
        gap: 12px;
        margin-top: 28px;
      }

      .btn-primary {
        flex: 1;
        padding: 14px 28px;
        background: var(--primary);
        color: var(--primary-foreground);
        border: none;
        border-radius: var(--radius-lg);
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary:hover:not(:disabled) {
        background: #0353a4;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(4, 102, 200, 0.3);
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-secondary {
        flex: 1;
        padding: 14px 28px;
        background: var(--secondary);
        color: var(--primary);
        border: none;
        border-radius: var(--radius-lg);
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-secondary:hover {
        background: var(--primary);
        color: white;
      }

      .skip-link {
        text-align: center;
        margin-top: 16px;
        font-size: 14px;
        color: var(--muted-foreground);
      }

      .skip-link a {
        color: var(--primary);
        text-decoration: none;
        font-weight: 600;
      }

      .skip-link a:hover {
        text-decoration: underline;
      }

      .error-message {
        background: #fee;
        border: 2px solid #fcc;
        color: #c33;
        padding: 12px;
        border-radius: var(--radius-lg);
        font-size: 14px;
        margin-bottom: 20px;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Sidebar Navigation -->
      <aside class="sidebar">
        <div class="logo-area">
          <div class="logo-icon">
           <iconify-icon
              icon="lucide:activity"
              style="font-size: 20px; color: var(--primary-foreground)"
            ></iconify-icon>
          </div>
          <div class="logo-text">KantanCare</div>
        </div>

        <nav class="nav-group">
         
          <a href="patient-dashboard.html" class="nav-item">
            <iconify-icon icon="lucide:home" style="font-size: 18px"></iconify-icon>
            Dashboard
          </a>
          <a href="Symptom_Check.html" class="nav-item">
            <iconify-icon icon="lucide:stethoscope" style="font-size: 18px"></iconify-icon>
            Symptom Check
          </a>
          <a href="Appointments.html" class="nav-item">
            <iconify-icon icon="lucide:calendar" style="font-size: 18px"></iconify-icon>
            Appointments
          </a>
          <a href="History.html" class="nav-item">
            <iconify-icon icon="lucide:clipboard-list" style="font-size: 18px"></iconify-icon>
            History
          </a>
          <div class="nav-item  ">
            <iconify-icon icon="lucide:clipboard-plus" style="font-size: 18px"></iconify-icon>
            <a href="medical-records.html" style="color: inherit; text-decoration: none;">Records</a>
          </div>
        </nav>

        <div class="spacer"></div>

        <nav class="nav-group">
          <div class="nav-label">Settings</div>
          <a href="medical-profile-setup.html" class="nav-item active">
            <iconify-icon icon="lucide:user" style="font-size: 18px"></iconify-icon>
            Profile
          </a>
        </nav>
      </aside>

      <!-- Main Content Area -->
      <main class="main-content">
        <!-- Top Bar -->
        <header class="top-bar">
          <div class="breadcrumbs">
            <span>Settings</span>
            <iconify-icon icon="lucide:chevron-right" style="font-size: 14px"></iconify-icon>
            <span class="breadcrumb-active">Medical Profile Setup</span>
          </div>
        </header>

        <!-- Scrollable Form Area -->
        <div class="scroll-area">
          <div class="content-width">
            <div class="header-section">
              <h1 class="page-title">Complete Your Medical Profile</h1>
              <div class="page-subtitle">
                This information helps us provide better care recommendations and streamline your consultations.
              </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-wrapper">
              <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
              </div>
              <div class="step-indicator">
                <span id="stepLabel1" class="active">Step 1: Basic Info</span>
                <span id="stepLabel2">Step 2: Medical History</span>
              </div>
            </div>

            <!-- Error Message -->
            <div class="error-message" id="errorMessage"></div>

            <!-- Step 1: Basic Information -->
            <div class="form-card">
              <div class="step active" id="step1">
                <div class="step-title">Basic Information</div>
                <div class="step-subtitle">Let's start with some basic health information</div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Age *</label>
                    <input type="number" id="age" placeholder="25" min="0" max="150" required>
                  </div>

                  <div class="form-group">
                    <label>Gender *</label>
                    <select id="gender" required>
                      <option value="">Select gender</option>
                      <option value="male">Male</option>
                      <option value="female">Female</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Blood Type</label>
                    <select id="bloodType">
                      <option value="">Select blood type</option>
                      <option value="A+">A+</option>
                      <option value="A-">A-</option>
                      <option value="B+">B+</option>
                      <option value="B-">B-</option>
                      <option value="AB+">AB+</option>
                      <option value="AB-">AB-</option>
                      <option value="O+">O+</option>
                      <option value="O-">O-</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>Weight (kg)</label>
                    <input type="number" id="weight" placeholder="70" step="0.1">
                  </div>
                </div>

                <div class="button-group">
                  <button type="button" class="btn-primary" onclick="nextStep()">Next Step</button>
                </div>
              </div>

              <!-- Step 2: Medical History -->
              <div class="step" id="step2">
                <div class="step-title">Medical History</div>
                <div class="step-subtitle">Help us understand your health background</div>

                <div class="info-box">
                  ðŸ’¡ This information reduces repeated questions during consultations and helps doctors make better decisions.
                </div>

                <div class="form-group">
                  <label>Known Allergies</label>
                  <textarea id="allergies" placeholder="E.g., Penicillin, Peanuts, Latex (leave blank if none)"></textarea>
                </div>

                <div class="form-group">
                  <label>Current Medications</label>
                  <textarea id="medications" placeholder="E.g., Cetirizine 10mg/day, Vitamin D Weekly (leave blank if none)"></textarea>
                </div>

                <div class="form-group">
                  <label>Chronic Conditions (Optional)</label>
                  <textarea id="chronicConditions" placeholder="E.g., Hypertension, Diabetes, Asthma (leave blank if none)"></textarea>
                </div>

                <div class="button-group">
                  <button type="button" class="btn-secondary" onclick="prevStep()">Back</button>
                  <button type="button" class="btn-primary" id="submitBtn" onclick="submitProfile()">Complete Setup</button>
                </div>

                <div class="skip-link">
                  <a href="#" onclick="skipProfile()">Skip for now, complete later</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBNYwM7ySCuyog04dJrWugBig41qh2Pu4U",
            authDomain: "kantan-d6e74.firebaseapp.com",
            projectId: "kantan-d6e74",
            storageBucket: "kantan-d6e74.firebasestorage.app",
            messagingSenderId: "199639000224",
            appId: "1:199639000224:web:662872c3eeb09b24e555c5",
            measurementId: "G-658L3RPXFZ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentStep = 1;
        let userId = null;
        let isEditMode = false;

        // Check authentication and load existing data
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                userId = user.uid;
                
                // Load existing profile data if available
                try {
                    const userDoc = await db.collection('users').doc(userId).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        
                        // Check if profile already has data (edit mode)
                        if (userData.age || userData.gender) {
                            isEditMode = true;
                            prefillForm(userData);
                            updateUIForEditMode();
                        }
                    }
                } catch (error) {
                    console.error('Error loading profile:', error);
                }
            }
        });

        // Prefill form with existing data
        function prefillForm(data) {
            // Step 1 fields
            if (data.age) document.getElementById('age').value = data.age;
            if (data.gender) document.getElementById('gender').value = data.gender;
            if (data.bloodType) document.getElementById('bloodType').value = data.bloodType;
            if (data.weight) document.getElementById('weight').value = data.weight;
            
            // Step 2 fields
            if (data.allergies) document.getElementById('allergies').value = data.allergies;
            if (data.currentMedications) document.getElementById('medications').value = data.currentMedications;
            if (data.chronicConditions) document.getElementById('chronicConditions').value = data.chronicConditions;
        }

        // Update UI for edit mode
        function updateUIForEditMode() {
            // Change header text
            document.querySelector('.page-title').textContent = 'Update Your Medical Profile';
            document.querySelector('.page-subtitle').textContent = 'Keep your health information up to date';
            
            // Change button text
            document.getElementById('submitBtn').textContent = 'Save Changes';
            
            // Change info box text
            const infoBox = document.querySelector('.info-box');
            if (infoBox) {
                infoBox.innerHTML = 'ðŸ’¡ Updating your profile helps doctors provide better care and recommendations.';
            }
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => errorDiv.classList.remove('show'), 5000);
        }

        // Navigate to next step
        function nextStep() {
            // Validate Step 1
            const age = document.getElementById('age').value;
            const gender = document.getElementById('gender').value;

            if (!age || !gender) {
                showError('Please fill in all required fields (Age and Gender).');
                return;
            }

            if (age < 0 || age > 150) {
                showError('Please enter a valid age.');
                return;
            }

            currentStep = 2;
            updateUI();
        }

        // Navigate to previous step
        function prevStep() {
            currentStep = 1;
            updateUI();
        }

        // Update UI based on current step
        function updateUI() {
            // Hide all steps
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            
            // Show current step
            document.getElementById(`step${currentStep}`).classList.add('active');

            // Update progress bar
            const progress = (currentStep / 2) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            // Update step labels
            document.querySelectorAll('.step-indicator span').forEach(span => span.classList.remove('active'));
            document.getElementById(`stepLabel${currentStep}`).classList.add('active');
        }

        // Submit medical profile
        async function submitProfile() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            
            if (isEditMode) {
                submitBtn.innerHTML = '<span class="loading"></span> Saving Changes...';
            } else {
                submitBtn.innerHTML = '<span class="loading"></span> Saving...';
            }

            try {
                // Collect all form data
                const profileData = {
                    // Basic Info
                    age: parseInt(document.getElementById('age').value),
                    gender: document.getElementById('gender').value,
                    bloodType: document.getElementById('bloodType').value || '',
                    weight: document.getElementById('weight').value ? parseFloat(document.getElementById('weight').value) : null,
                    
                    // Medical History
                    allergies: document.getElementById('allergies').value.trim(),
                    currentMedications: document.getElementById('medications').value.trim(),
                    chronicConditions: document.getElementById('chronicConditions').value.trim(),
                    
                    // Metadata
                    profileComplete: true,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Add profileCompletedAt only if first time completing
                if (!isEditMode) {
                    profileData.profileCompletedAt = firebase.firestore.FieldValue.serverTimestamp();
                }

                // Update user document in Firestore
                await db.collection('users').doc(userId).update(profileData);

                // Show success message
                if (isEditMode) {
                    alert('âœ… Profile updated successfully!');
                }

                // Redirect to patient dashboard
                window.location.href = 'patient-dashboard.html';

            } catch (error) {
                console.error('Error saving profile:', error);
                showError('Failed to save profile. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = isEditMode ? 'Save Changes' : 'Complete Setup';
            }
        }

        // Skip profile completion
        function skipProfile() {
            if (confirm('Are you sure you want to skip? You can complete your profile later from the dashboard.')) {
                window.location.href = 'patient-dashboard.html';
            }
        }
    </script>
  </body>
</html>
